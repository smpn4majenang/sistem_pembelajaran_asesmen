<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembelajaran & Asesmen - SMPN 4 Majenang</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Font (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Animation Utilities */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.5s ease-out; }
        .slide-right { animation: slideRight 0.3s ease-out; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        
        /* Hide Scrollbar for cleaner look in modals */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 flex flex-col min-h-screen">

    <!-- HEADER -->
    <header class="bg-blue-900 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-white p-1.5 rounded-lg text-blue-900 shadow-sm">
                    <i data-lucide="school" width="22"></i>
                </div>
                <div class="leading-tight">
                    <h1 class="text-base md:text-lg font-bold">SISTEM PEMBELAJARAN DAN ASESMEN</h1>
                    <p class="text-[10px] md:text-xs text-blue-200 opacity-90">SMP NEGERI 4 MAJENANG</p>
                </div>
            </div>
            <!-- Tombol refresh data manual -->
            <button onclick="window.location.reload()" class="p-2 hover:bg-blue-800 rounded-full transition-colors" title="Muat Ulang Data">
                <i data-lucide="refresh-cw" width="20"></i>
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT CONTAINER -->
    <main id="app-container" class="flex-1 flex flex-col relative">
        <!-- Views will be injected here via JavaScript -->
        <div class="flex flex-col items-center justify-center h-[80vh] text-gray-400">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mb-4"></div>
            <p>Memuat data sistem...</p>
        </div>
    </main>

    <!-- FOOTER -->
    <footer id="main-footer" class="bg-white border-t py-6 mt-auto">
        <div class="container mx-auto text-center text-sm text-gray-500">
            <p class="font-semibold text-gray-700">&copy; <span id="year"></span> SMP Negeri 4 Majenang</p>
            <p class="text-xs mt-1">Sistem Pembelajaran dan Asesmen SMP Negeri 4 Majenang</p>
        </div>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // =================================================================
        // KONFIGURASI UTAMA (Paste ID Google Sheet di sini)
        // =================================================================
        const GOOGLE_SHEET_ID = "1TAq2LiT663wxPHwbWBnRN1KbkjBnGMwcU5PgsZWiQpg"; // <-- PASTE ID DI SINI (Contoh: "1BxiMvs...")
        // =================================================================

        let state = {
            view: 'home', // home, list, action
            actionType: null, // input, check, jurnalGuru, jurnalKelas
            selectedItem: null,
            searchTerm: '',
            teachers: [],
            classes: [],
            loading: true,
            error: null
        };

        // --- INIT ---
        document.getElementById('year').textContent = new Date().getFullYear();
        
        // Langsung muat data saat aplikasi dibuka
        initApp();

        async function initApp() {
            if (!GOOGLE_SHEET_ID) {
                renderError("ID Google Sheet belum dipasang di script. Silakan hubungi admin IT.");
                return;
            }

            try {
                const data = await fetchFromGoogleSheet(GOOGLE_SHEET_ID);
                state.teachers = data.teachers;
                state.classes = data.classes;
                state.loading = false;
                render(); 
            } catch (e) {
                console.error("Gagal memuat:", e);
                renderError("Gagal memuat data dari Google Sheet. Pastikan ID benar dan Sheet dipublikasikan ke Web (CSV).");
            }
        }

        function renderError(msg) {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-[80vh] p-8 text-center">
                    <i data-lucide="alert-triangle" width="48" class="text-red-500 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Terjadi Kesalahan</h3>
                    <p class="text-gray-600">${msg}</p>
                </div>
            `;
            lucide.createIcons();
        }

        // --- RENDER FUNCTION ---
        function render() {
            const container = document.getElementById('app-container');
            const footer = document.getElementById('main-footer');

            // Update Icons
            setTimeout(() => lucide.createIcons(), 50);

            // Toggle Footer
            footer.style.display = state.view === 'action' ? 'none' : 'block';

            // Router Logic
            if (state.view === 'home') {
                container.innerHTML = renderHome();
            } else if (state.view === 'list') {
                container.innerHTML = renderList();
            } else if (state.view === 'action') {
                container.innerHTML = renderAction();
            }
        }

        // --- VIEWS ---
        function renderHome() {
            return `
                <div class="flex flex-col items-center justify-center min-h-[75vh] p-4 slide-up">
                    <div class="text-center mb-8 max-w-lg mx-auto">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Menu Layanan</h2>
                        <p class="text-gray-500 text-sm md:text-base">Silakan pilih menu layanan akademik yang Anda butuhkan di bawah ini.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 w-full max-w-6xl px-2 md:px-6">
                        ${renderHomeButton('input', 'Input Nilai', 'Form Nilai Guru', 'file-input', 'green')}
                        ${renderHomeButton('check', 'Cek Nilai', 'Rekap Nilai Siswa', 'table', 'blue')}
                        ${renderHomeButton('jurnalGuru', 'Jurnal Guru', 'Agenda Harian Guru', 'clipboard-list', 'orange')}
                        ${renderHomeButton('jurnalKelas', 'Jurnal Kelas', 'Absensi Siswa/Kelas', 'book-marked', 'purple')}
                    </div>
                </div>
            `;
        }

        function renderHomeButton(id, label, desc, icon, color) {
            return `
                <button onclick="handleMenuClick('${id}')" 
                    class="group relative overflow-hidden bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border border-gray-100 p-5 flex flex-col items-center text-center gap-3 hover:-translate-y-1 ring-1 ring-transparent hover:ring-${color}-200">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-${color}-500"></div>
                    <div class="p-3.5 rounded-full bg-${color}-50 text-${color}-600 group-hover:bg-${color}-500 group-hover:text-white transition-colors duration-300 shadow-sm">
                        <i data-lucide="${icon}" width="28"></i>
                    </div>
                    <div class="flex-1 flex flex-col justify-center">
                        <h3 class="text-lg font-bold text-gray-800">${label}</h3>
                        <p class="text-xs text-gray-500 mt-1">${desc}</p>
                    </div>
                    <div class="mt-2 w-full py-2 bg-gray-50 rounded-lg text-xs font-semibold text-gray-600 group-hover:bg-${color}-50 group-hover:text-${color}-700 transition-colors">
                        Buka Menu
                    </div>
                </button>
            `;
        }

        function renderList() {
            const isClassMode = state.actionType === 'jurnalKelas';
            const dataSource = isClassMode ? state.classes : state.teachers;
            
            const filtered = dataSource.filter(item => 
                item.name.toLowerCase().includes(state.searchTerm.toLowerCase()) || 
                (item.subject && item.subject.toLowerCase().includes(state.searchTerm.toLowerCase()))
            );

            const theme = getThemeColor(state.actionType);
            const menuTitleMap = { input: "Input Nilai", check: "Cek Nilai", jurnalGuru: "Jurnal Guru", jurnalKelas: "Jurnal Kelas" };
            const menuTitle = menuTitleMap[state.actionType];

            let listHtml = '';
            if (filtered.length > 0) {
                listHtml = filtered.map(item => {
                    let subHtml = '';
                    if (isClassMode) {
                        subHtml = `
                            <div class="flex items-center gap-2">
                                <i data-lucide="external-link" width="16" class="text-${theme}-600 shrink-0"></i> 
                                <span class="font-bold text-${theme}-700">Link Jurnal Kelas</span>
                            </div>`;
                    } else {
                        const subjects = item.subject.split(',').map(s => s.trim()).filter(s => s);
                        subHtml = subjects.map(s => `
                            <div class="flex items-center gap-2">
                                <i data-lucide="book-open" width="16" class="shrink-0 text-${theme}-600"></i> 
                                <span class="truncate font-bold text-${theme}-700">${s}</span>
                            </div>
                        `).join('');
                    }

                    return `
                    <button onclick='handleItemClick(${JSON.stringify(item).replace(/'/g, "&#39;")})'
                        class="flex items-start gap-3 p-4 bg-white rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-all text-left group ring-1 ring-transparent hover:border-${theme}-300">
                        <div class="mt-1 p-2.5 rounded-full bg-${theme}-100 text-${theme}-600 group-hover:scale-110 transition-transform shrink-0">
                            <i data-lucide="${isClassMode ? 'users' : 'user'}" width="20"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <h4 class="font-bold text-gray-900 text-base md:text-lg truncate mb-1">${item.name}</h4>
                            <div class="text-sm flex flex-col gap-1">
                                ${subHtml}
                            </div>
                        </div>
                    </button>
                    `;
                }).join('');
            } else {
                listHtml = `
                    <div class="flex flex-col items-center justify-center py-16 text-gray-400 bg-white rounded-xl border border-dashed border-gray-200 col-span-full">
                        <i data-lucide="search" width="48" class="mb-2 opacity-20"></i>
                        <p>Data ${isClassMode ? 'kelas' : 'guru'} tidak ditemukan.</p>
                    </div>
                `;
            }

            return `
                <div class="container mx-auto p-4 max-w-5xl fade-in min-h-[80vh]">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <button onclick="handleBack()" class="flex items-center text-gray-600 hover:text-gray-900 font-medium transition-colors gap-1 pl-1">
                            <i data-lucide="chevron-left" width="20"></i> Kembali
                        </button>
                        <div class="px-4 py-1.5 rounded-full text-sm font-bold bg-${theme}-50 text-${theme}-800 border border-${theme}-500 self-start md:self-auto">
                            ${menuTitle}
                        </div>
                    </div>

                    <div class="relative mb-6 group">
                        <input
                            type="text"
                            oninput="handleSearch(this.value)"
                            value="${state.searchTerm}"
                            placeholder="${isClassMode ? 'Cari nama kelas...' : 'Cari nama guru atau mapel...'}"
                            class="w-full pl-11 pr-4 py-3.5 rounded-xl border border-gray-200 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all group-hover:border-blue-300"
                        >
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                            <i data-lucide="search" width="20"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                        ${listHtml}
                    </div>
                </div>
            `;
        }

        function renderAction() {
            const item = state.selectedItem;
            let link = "#";
            let title = "";
            let subTitle = item.type === 'class' ? 'Absensi & Jurnal' : item.subject;

            if (state.actionType === 'input') { link = item.linkInput; title = "Input Nilai"; }
            else if (state.actionType === 'check') { link = item.linkCek; title = "Data Nilai"; }
            else if (state.actionType === 'jurnalGuru') { link = item.linkJurnalGuru; title = "Jurnal Guru"; }
            else if (state.actionType === 'jurnalKelas') { link = item.linkJurnal; title = "Jurnal Kelas"; }

            const isInvalid = !link || link === '#' || link.length < 5;
            const theme = getThemeColor(state.actionType);

            let contentHtml = '';
            if (isInvalid) {
                contentHtml = `
                    <div class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center">
                        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md border border-gray-100">
                            <div class="mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 bg-${theme}-100 text-${theme}-600">
                                <i data-lucide="alert-circle" width="32"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Link Belum Tersedia</h3>
                            <p class="text-gray-600 mb-6 text-sm">
                                Maaf, link untuk <strong>${item.name}</strong> belum diatur oleh admin.
                            </p>
                            <button onclick="handleBack()" class="px-6 py-2.5 bg-gray-900 text-white rounded-lg hover:bg-black transition-colors text-sm font-medium">
                                Kembali
                            </button>
                        </div>
                    </div>
                `;
            } else {
                contentHtml = `
                    <div class="absolute top-0 left-0 w-full bg-yellow-50 px-4 py-2 text-[10px] md:text-xs text-yellow-800 flex items-center justify-center gap-2 border-b border-yellow-100 z-10">
                        <i data-lucide="info" width="14"></i>
                        <span>Jika halaman kosong, klik tombol <strong>"Buka di Tab Baru"</strong>.</span>
                    </div>
                    <iframe 
                        src="${link}" 
                        class="w-full h-full border-none pt-8" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-top-navigation">
                    </iframe>
                `;
            }

            return `
                <div class="flex flex-col h-[calc(100vh-64px)] bg-gray-50 slide-right">
                    <div class="bg-white border-b px-4 py-3 flex items-center justify-between shadow-sm z-20">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <button onclick="handleBack()" class="p-2 -ml-2 hover:bg-gray-100 rounded-full text-gray-600 transition-colors">
                                <i data-lucide="chevron-left" width="24"></i>
                            </button>
                            <div class="border-l pl-3 border-gray-200">
                                <h2 class="font-bold text-gray-800 text-sm md:text-base truncate max-w-[150px] md:max-w-md">${item.name}</h2>
                                <p class="text-[10px] md:text-xs font-bold text-${theme}-800 uppercase tracking-wide">
                                    ${title} &bull; ${subTitle}
                                </p>
                            </div>
                        </div>
                        ${!isInvalid ? `
                        <a href="${link}" target="_blank" class="flex items-center gap-2 text-xs md:text-sm font-medium px-3 py-2 rounded-lg hover:bg-${theme}-50 border border-gray-200 hover:border-${theme}-200 transition-colors text-${theme}-800">
                            <span class="hidden sm:inline">Buka di Tab Baru</span>
                            <span class="sm:hidden">Buka</span>
                            <i data-lucide="external-link" width="14"></i>
                        </a>` : ''}
                    </div>
                    <div class="flex-1 relative w-full h-full bg-white">
                        ${contentHtml}
                    </div>
                </div>
            `;
        }

        // --- ACTIONS ---
        function handleMenuClick(type) {
            state.actionType = type;
            state.view = 'list';
            state.searchTerm = '';
            render();
        }

        function handleItemClick(item) {
            state.selectedItem = item;
            state.view = 'action';
            render();
        }

        function handleBack() {
            if (state.view === 'action') {
                state.view = 'list';
                state.selectedItem = null;
            } else if (state.view === 'list') {
                state.view = 'home';
                state.actionType = null;
            }
            render();
        }

        function handleSearch(val) {
            state.searchTerm = val;
            render();
            const input = document.querySelector('input[type="text"]');
            if(input) {
                input.focus();
                input.setSelectionRange(input.value.length, input.value.length);
            }
        }

        function getThemeColor(type) {
            switch(type) {
                case 'input': return 'green';
                case 'check': return 'blue';
                case 'jurnalGuru': return 'orange';
                case 'jurnalKelas': return 'purple';
                default: return 'gray';
            }
        }

        // Core Fetch Logic
        async function fetchFromGoogleSheet(id) {
            const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv`;
            const response = await fetch(url);
            if (!response.ok) throw new Error("Gagal. Pastikan Sheet Publik.");
            
            const text = await response.text();
            const rows = parseCSV(text);

            const loadedTeachers = rows.slice(1).map((row, index) => ({
                id: `t-${index}`,
                name: row[0] || "",
                subject: row[1] || "Mapel Umum",
                linkInput: row[2] || "#",
                linkCek: row[3] || "#",
                linkJurnalGuru: row[4] || "#",
                type: 'teacher'
            })).filter(t => t.name !== "" && t.name.toLowerCase() !== "nama guru");

            const loadedClasses = rows.slice(1).map((row, index) => ({
                id: `c-${index}`,
                name: row[6] || "",
                linkJurnal: row[7] || "#",
                type: 'class'
            })).filter(c => c.name !== "" && c.name.toLowerCase() !== "nama kelas");

            return { teachers: loadedTeachers, classes: loadedClasses };
        }

        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = "";
            let insideQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') { insideQuotes = !insideQuotes; }
                else if (char === ',' && !insideQuotes) { currentRow.push(currentCell.trim()); currentCell = ""; }
                else if (char === '\n' && !insideQuotes) { currentRow.push(currentCell.trim()); rows.push(currentRow); currentRow = []; currentCell = ""; }
                else { currentCell += char; }
            }
            if (currentCell) currentRow.push(currentCell.trim());
            if (currentRow.length > 0) rows.push(currentRow);
            return rows;
        }
    </script>
</body>
</html>
